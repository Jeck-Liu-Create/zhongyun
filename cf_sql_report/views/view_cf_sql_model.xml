<?xml version="1.0" encoding="UTF-8" ?>
<!--
# **********************
# 盛哲康虎信息技术（厦门）有限公司
# http://www.khcloud.net
# QQ: 360026606
# wechat: 360026606
# **********************
-->
<odoo>
    <record id="view_cf_sql_model_tree" model="ir.ui.view">
        <field name="model">cf.sql.model</field>
        <field name="arch" type="xml">
            <tree decoration-info="state=='draft'" decoration-warning="state in ('sql_valid', 'model_valid')" >
                <field name="sequence" widget="handle" />
                <field name="name" />
                <field name="tech_name" />
                <field name="is_materialized" />
                <field name="size" />
                <field name="parent_menu_id" />
                <field name="state" />
            </tree>
        </field>
    </record>

    <record id="view_cf_sql_model_form" model="ir.ui.view">
        <field name="model">cf.sql.model</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="button_validate_sql_expression" string="Validate SQL Expression" type="object"
                            states="draft" class="oe_highlight" />
                    <button name="button_set_draft" string="Set to Draft" type="object" states="sql_valid"
                            groups="cf_sql_report.group_sql_report_manager" />
                    <button name="button_set_draft" string="Set to Draft" type="object" states="model_valid,ui_valid"
                            groups="cf_sql_report.group_sql_report_manager"
                            confirm="Are you sure you want to set to draft this SQL View. It will delete the materialized view, and all the previous mapping realized with the columns"
                    />
                    <button name="button_create_sql_view_and_model" string="Create SQL Model" type="object" states="sql_valid"
                            class="oe_highlight"
                            help="This will try to create an SQL View, based on the SQL request and the according Transient Model and fields, based on settings"
                    />
                    <button name="button_update_model_access" string="Update Model Access" type="object"
                            attrs="{'invisible': ['|', ('state', 'in', ('draft', 'sql_valid')), ('has_group_changed', '=', False)]}"
                            class="oe_highlight"
                            help="Update Model Access. Required if you changed groups list after having created the model"
                    />
                    <button name="button_create_ui" string="Create Odoo UI" type="object" states="model_valid"
                            class="oe_highlight" help="This will create Odoo View, Action and Menu"
                    />
                    <button name="button_refresh_materialized_view" string="Refresh Materialized View" type="object"
                            attrs="{'invisible': ['|', ('state', 'in', ('draft', 'sql_valid')), ('is_materialized', '=', False)]}"
                            help="this will refresh the materialized view"
                    />
                    <field name="state" widget="statusbar" />
                </header>
                <sheet>
                    <h1>
                        <field name="name" attrs="{'readonly': [('state','!=','draft')]}" colspan="4"
                               placeholder="Please enter the name of SQL view" />
                    </h1>
                    <group>
                        <field name="tech_name" attrs="{'readonly': [('state', '!=', 'draft')]}"
                               placeholder="Please enter the technical name of SQL view. This name will be a part of view full name." />
                        <field name="view_name" />
                        <field name="is_materialized" />
                        <field name="size" attrs="{'invisible': ['|', ('state', '=', 'draft'), ('is_materialized', '=', False)]}"/>
                        <field name="cron_id" attrs="{'invisible': ['|', ('state', 'in', ('draft', 'sql_valid')), ('is_materialized', '=', False)]}" />
                        <field name="view_order" placeholder="Please enter the order of odoo views for this model." invisible="True" />
                        <field name="parent_menu_id" placeholder="Please select the menu that the created UI to attach.." />
                    </group>
                    <group string="SQL Query">
                        <field name="query" nolabel="1" colspan="4" attrs="{'readonly': [('state', '!=', 'draft')]}"
                               style="border: 0.2rem solid rgba(26, 127, 234, 0.74); margin: 10px; padding: 15px;
                               width: 100%; font-size: 1.3rem; resize: yes;"
                               placeholder="Please enter SQL Query to be create SQL view" />
                        <button name="button_preview_sql_expression" class="oe_highlight" string="Preview SQL Query" type="object" states="draft" />
                    </group>
                    <notebook>
                        <page string="Helps">
                            <div>
                                <h3>Tips of useage</h3>
                                <ul>
                                    <li>
                                        <b>设置ID（<font color="red">重要</font>）</b><br/>
                                        在 <i>SELECT</i> 后面要增加“<i>id</i>”字段，以便从表中取出原记录的ID作为视图记录的ID，否则会自动生成ID字段，导致关联查询不正确。<br/>
                                        例如：<br/>
<pre>SELECT
    P.id,                               /*取出原表ID字段作为视图的主键，注意不能以“<i>x_</i>”开头*/
    P.name AS x_name,
    C.id AS x_m2o_country_id,           /*实现many2one关联到国家（res_country ）*/
    C.name AS x_country_name,
    C.code AS x_country_code,
    cr.name AS x_currency_name,
    s.id AS x_m2o_state_id,             /*实现many2one关联到省/州（res_country_state）*/
    s.name AS x_state_name,
    s.code AS x_state_code,
    '{"model_id": "sale.order", "relation_field": "partner_id" }' AS x_o2m_sale_orders  /*实现one2many关联到销售订单(sale.order)*/
FROM res_partner P
    LEFT JOIN res_country_state s ON P.state_id = s.id
    LEFT JOIN res_country C ON s.country_id = C.id
    LEFT JOIN res_currency cr ON C.currency_id = cr.id
ORDER BY P.id
                                        </pre>
                                    </li>
                                    <li>
                                        <b>如何实现 many2one 关联：</b><br/>
                                        在SQL语句中，查询关联模型的id字段并重命名为 x_m2o_model_id 格式即可 （其中，x_是前缀，model是关联模型名称或简称，_id是后缀）。<br/>
                                        例如：<br/>
                                        <pre>
    res_country.id AS <b><i>x_m2o_country_id</i></b>
                                        </pre>
                                    </li>
                                    <li>
                                        <b>如何实现 one2many 关联：</b><br/>
                                        1、在SQL语句中，按下列格式查询关联表数据：<br/>
                                        <pre>
    '{"model":"sale.order", "relation_field": "partner_id"}' AS x_o2m_sale_orders
                                        </pre>
                                    </li>
                                </ul>
                            </div>
                        </page>
                        <page string="SQL Fields" attrs="{'invisible': [('state', '=', 'draft')]}" >
                            <field name="cf_sql_model_field_ids" nolabel="1" colspan="4" attrs="{'readonly': [('state', '!=', 'sql_valid')]}" >
                                <tree editable="bottom" decoration-info="field_description==False" >
                                    <field name="sequence" />
                                    <field name="name" />
                                    <field name="sql_type" />
                                    <field name="field_description" />
                                    <field name="ttype" attrs="{ 'required': [('field_description', '!=', False)]}" />
                                    <field name="relation_model_id" attrs="{
                                            'invisible': [('ttype', 'not in', ('many2one', 'one2many'))],
                                            'required': [('field_description', '!=', False), ('ttype', 'in',  ('many2one', 'one2many'))]}"/>
                                    <field name="selection" attrs="{
                                            'invisible': [('ttype', '!=', 'selection')],
                                            'required': [('field_description', '!=', False), ('ttype', '=', 'selection')]
                                           }"/>
                                    <field name="is_index" attrs="{'invisible': [('field_description', '=', False)]}" />
                                    <field name="is_group_by" attrs="{'invisible': [('field_description', '=', False)]}" />
                                    <field name="graph_type" attrs="{'invisible': [('field_description', '=', False)]}" />
                                    <field name="tree_visibility" attrs="{'invisible': [('field_description', '=', False)]}" />
                                </tree>
                            </field>
                        </page>
                        <page string="Security" attrs="{'invisible': [('state', '=', 'draft')]}">
                            <notebook>
                                <page string="Data Access Rule">
                                   <group>
                                        <field name="domain_force" nolabel="1" colspan="4" />
                                        <div>
                                            在上面输入框中定义数据访问权限.<br/>
                                            <ul>
                                                <li>注意字段必须以'x_'开头</li>
                                                <li>定义的规则会生成一个全局'ir.rule'规则记录</li>
                                                <li>例如：['|', ('x_partner_id','child_of', [user.partner.id])]</li>
                                            </ul>
                                        </div>
                                    </group>
                                </page>
                                <page string="Allowed Groups">
                                    <group>
                                        <field name="group_ids" nolabel="1" colspan="4" />
                                        <field name="has_group_changed" invisible="1" />
                                    </group>
                                </page>
                            </notebook>
                        </page>
                        <page string="Action Settings"
                              attrs="{'invisible': [('state', '=', 'draft')]}">
                            <group string="Action Context">
                                <field name="action_context" nolabel="1" colspan="4" />
                                <div>
                                    在上面输入框中定义创建action时默认使用的上下文参数。
                                </div>
                            </group>
                        </page>
                        <page string="Odoo UI" attrs="{'invisible': [('state', '=', 'draft')]}">
                            <group>
                                <button name="button_open_view" string="Open View" type="object" states="ui_valid" class="oe_highlight" />
                            </group>
                            <notebook>
                                <page string="Created Model">
                                    <group>
                                        <field name="model_name" />
                                        <field name="model_id" attrs="{'invisible': [('state', '=', 'draft')]}" />
                                    </group>
                                </page>
                                <page string="Created User Interface">
                                    <group>
                                        <group>
                                            <field name="tree_view_id" />
                                            <field name="form_view_id" />
                                            <field name="graph_view_id" />
                                            <field name="pivot_view_id" />
                                        </group>
                                        <group>
                                            <field name="search_view_id" />
                                            <field name="action_id" />
                                            <field name="menu_id" />
                                        </group>
                                    </group>
                                </page>
                            </notebook>
                        </page>
                        <page string="Notes">
                            <field name="notes"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>
</odoo>
